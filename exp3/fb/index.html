
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.3">
    
    
      
        <title>3 bonus: Interrupt-driven animation - p1-kernel</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e8d9bf0c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
          
          
          <meta name="theme-color" content="#7e56c2">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#3-bonus-interrupt-driven-animation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="p1-kernel" class="md-header__button md-logo" aria-label="p1-kernel" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            p1-kernel
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3 bonus: Interrupt-driven animation
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../exp0/rpi-os/" class="md-tabs__link">
      exp0
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../exp1/rpi-os/" class="md-tabs__link">
      exp1
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../exp2/rpi-os/" class="md-tabs__link">
      exp2
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../rpi-os/" class="md-tabs__link">
      exp3
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../exp4a/rpi-os/" class="md-tabs__link">
      exp4a
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../exp4b/rpi-os/" class="md-tabs__link">
      exp4b
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../exp5/rpi-os/" class="md-tabs__link">
      exp5
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../exp6/rpi-os/" class="md-tabs__link">
      exp6
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../qemu/" class="md-tabs__link">
      /qemu
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../gdb/" class="md-tabs__link">
      /gdb
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../cheatsheet/" class="md-tabs__link">
      /aarch64
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../ssh-proxy/" class="md-tabs__link">
      /ssh
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../dump/" class="md-tabs__link">
      /ker dump
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../jtag/" class="md-tabs__link">
      /jtag
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="p1-kernel" class="md-nav__button md-logo" aria-label="p1-kernel" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    p1-kernel
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../exp0/rpi-os/" class="md-nav__link">
        exp0
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../exp1/rpi-os/" class="md-nav__link">
        exp1
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../exp2/rpi-os/" class="md-nav__link">
        exp2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../rpi-os/" class="md-nav__link">
        exp3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../exp4a/rpi-os/" class="md-nav__link">
        exp4a
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../exp4b/rpi-os/" class="md-nav__link">
        exp4b
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../exp5/rpi-os/" class="md-nav__link">
        exp5
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../exp6/rpi-os/" class="md-nav__link">
        exp6
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../qemu/" class="md-nav__link">
        /qemu
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../gdb/" class="md-nav__link">
        /gdb
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheet/" class="md-nav__link">
        /aarch64
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../ssh-proxy/" class="md-nav__link">
        /ssh
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../dump/" class="md-nav__link">
        /ker dump
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../jtag/" class="md-nav__link">
        /jtag
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#environment" class="md-nav__link">
    Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    Quick start
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#result-rpi3" class="md-nav__link">
    Result (Rpi3)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
    <nav class="md-nav" aria-label="Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rpi3-framebuffer-properties" class="md-nav__link">
    Rpi3 framebuffer properties
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qemus-emulation-caveats" class="md-nav__link">
    QEMU's emulation caveats
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kernel-code-walkthrough" class="md-nav__link">
    Kernel code walkthrough
  </a>
  
    <nav class="md-nav" aria-label="Kernel code walkthrough">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-the-framebuffer" class="md-nav__link">
    Set up the framebuffer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adjust-the-linker-script" class="md-nav__link">
    Adjust the linker script
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updating-the-framebuffer" class="md-nav__link">
    Updating the framebuffer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#known-issues" class="md-nav__link">
    Known issues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#as-tribute-to" class="md-nav__link">
    As tribute to...
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="3-bonus-interrupt-driven-animation">3 bonus: Interrupt-driven animation</h1>
<p>This is optional for the course purpose. Thus, this write up is not intended to be as thorough as others. </p>
<h2 id="objectives">Objectives</h2>
<ol>
<li>See a use case of interrupts</li>
<li>Learn about framebuffer </li>
<li>Have some eye candy. </li>
</ol>
<h2 id="environment">Environment</h2>
<p><strong>Rpi3</strong>: need an HDMI cable connecting to a display. </p>
<p><strong>QEMU</strong>: run QEMU locally as we need an emulated display. </p>
<p><strong>Windows users</strong>: recommend to download prebuilt QEMU binaries. https://www.qemu.org/download/. You can build QEMU from source within WSL. I did that. Make sure to include graphics support. Likely slower than native binaries. </p>
<p>To invoke prebuilt QEMU from PowerShell: </p>
<p><img alt="image-20210225131456228" src="../image-20210225131456228.png" /></p>
<p><strong>Mac users</strong>: Ditto. See link above. </p>
<p><strong>Linux users</strong>: apt-get; if you build from source, make sure to include graphics support. </p>
<h2 id="quick-start">Quick start</h2>
<pre><code>cd exp3-bonus
make clean
USE_QEMU=1 make # for QEMU
USE_QEMU make # for rpi3
</code></pre>
<p>Pre-built binaries for Rpi3:</p>
<p>https://github.com/fxlin/p1-kernel/releases/tag/p1exp3bonus</p>
<h2 id="result-rpi3">Result (Rpi3)</h2>
<p><img alt="" src="../rpi3-animation.gif" /></p>
<p>QEMU has caveats. See below. </p>
<h2 id="background">Background</h2>
<p><strong>Framebuffer</strong> A memory region for pixel data. In the simplest form, CPU write RGB values there and pixels will show up on the display. </p>
<p><strong>Mailbox.</strong> On Rpi3, CPU talks to GPU through hardware mailbox. It's a small piece of memory shared between CPU/GPU. CPU puts commands in the shared memory (mbox) and kicks the GPU by writing to a GPU register; GPU executes the commands and responds by writing results to the shared memory. Code: <code>mbox.c</code></p>
<h3 id="rpi3-framebuffer-properties"><strong>Rpi3 framebuffer properties</strong></h3>
<p>On Rpi3, CPU talks to the GPU to set up the framebuffer. This function constructs a mbox message for GPU with a series of framebuffer properties. </p>
<p><strong>Virtual height/width</strong> define the framebuffer dimension. CPU is responsible for providing these pixels. </p>
<p><strong>Physical height/width</strong> define a rectangular region of pixels to be displayed. These pixels are derived by GPU from the framebuffer. See below. </p>
<p><strong>Virtual offsets</strong> define the top-left corner of the physical region within the virtual region. </p>
<p><strong>Pitch (bytes)</strong> is the actual memory size that each pixel raw takes in the framebuffer. </p>
<p>Note: the following is based on (1) <a href="https://github.com/raspberrypi/firmware/wiki/Mailbox-property-interface">the Rpi foundation online documentation</a>; (2) QEMU source code for emulating Rpi3 GPU/display; (3) my experiments on Rpi3. </p>
<p>(1) can be vague or erroneous and (2) is rudimentary. </p>
<p><strong>Case 1</strong>: Virtual region &gt; physical region (i.e. the viewport is a strict subpart of the framebuffer). This can be useful for screen panning and double buffering. This is how game consoles implement scrolling, e.g. over a large map pre-rendered in memory. Here's an excellent video on GameBoy: https://www.youtube.com/watch?v=FzPTK91EJY8&amp;t=405s</p>
<p><img alt="" src="../images/fb/Slide1.PNG" /></p>
<p>The Rpi3 mechanism is shown in the figure above. </p>
<p>The hardware takes the pixels in from the viewport (defined by the phys region) in the framebuffer and sends to display. Scaling is applied before the final display. The viewport size does not necessarily correspond to the resolution on display. For instance, the viewport (phys height x width) can be 300x300; the final picture on the display could occupy the full screen (with x/y ratio preserved). This is also in the figure above. </p>
<p><strong>Case 2:</strong> Virtual region &lt; physical region (i.e. the viewport is a strict superpart of the framebuffer)</p>
<p><img alt="" src="../images/fb/Slide2.PNG" />
In this case, GPU scales the framebuffer pixels (virtual region) to the viewport (physical region). GPU seems to be doing interpolation to generate the additional pixels. Then GPU sends the physical region to display as above. </p>
<p>The virtual region can be very small. "On boot, the virtual size is set to 2x2. If a framebuffer is allocated without reconfiguring the virtual size, the screen will consist of four very large virtual pixels.  Coloured red, green, yellow and blue, they produce the "rainbow" startup screen." [2]. See the picture below. This is the default display when Rpi3 boots without any additional changes to its default 2x2 (four pixel) framebuffer. </p>
<p>Virtual offsets are ineffective. I confirmed that. QEMU code <code>fb_use_offsets</code> also suggests so. </p>
<p>The picture below: the virtual region: 64x48 filled with a test image of 64x48; the physical region: 600x600. </p>
<p><img alt="" src="../PXL_20210225_162751387.jpg" /></p>
<p>Case 3: otherwise? (untested. Per QEMU code virtual offsets will be ineffective).</p>
<h3 id="qemus-emulation-caveats">QEMU's emulation caveats</h3>
<p>(Observation based on QEMU's master branch as of Feb 2020.)</p>
<p>QEMU's emulation of Rpi3 display only realizes the most common cases, e.g. virt = physical with offsets=0. Beyond that, it's quite problematic. For instance, here's how QEMU would display when virt 64x48 &lt; physical 600x600, showing it does not implement scaling. </p>
<p><img alt="" src="../images/qemu-64x48-not-scaling.png" /></p>
<p>QEMU display will also flicker when CPU is updating offsets periodically. Likely a bug in the code below. </p>
<p><img alt="" src="../images/qemu-animation-flicker.gif" /></p>
<p><code>hw/misc/bcm2835_property.c</code> implements the CPU/GPU mailbox interface. Can see what framebuffer properties are implemented. </p>
<p><code>hw/display/bcm2835_fb.c</code> has the actual emulation logic. See <code>fb_use_offsets()</code> which only applies virt offsets when virtual is smaller than physical. <code>bcm2835_fb_validate_config()</code> is how QEMU think the Rpi3 framebuffer should work, which can be problematic. </p>
<h2 id="kernel-code-walkthrough">Kernel code walkthrough</h2>
<h3 id="set-up-the-framebuffer">Set up the framebuffer</h3>
<p><code>lfb.c</code> is the framebuffer code. <code>lfb_init</code> sets up the framebuffer dimension. <code>lfb_showicture()</code> fills in the framebuffer with pixels from an image. We do not load from an image file (no filesystem yet!). Instead, we convert an image to a C header (e.g. tv-test-scree.h) using GIMP. Pretty cool! </p>
<p><img alt="image-20210225124433215" src="../image-20210225124433215.png" /></p>
<p>The header looks like this: </p>
<pre><code>static unsigned int tv_width = 1280;
static unsigned int tv_height = 800;

/*  Call this macro repeatedly.  After each use, the pixel data can be extracted  */

#define HEADER_PIXEL(data,pixel) {\
pixel[0] = (((data[0] - 33) &lt;&lt; 2) | ((data[1] - 33) &gt;&gt; 4)); \
pixel[1] = ((((data[1] - 33) &amp; 0xF) &lt;&lt; 4) | ((data[2] - 33) &gt;&gt; 2)); \
pixel[2] = ((((data[2] - 33) &amp; 0x3) &lt;&lt; 6) | ((data[3] - 33))); \
data += 4; \
}
static char *tv_data =
    &quot;````````````````````````````````````````````````````````````````&quot;
    &quot;````````````````````````````````````````````````````````````````&quot;
    &quot;`0T]I+#A!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;
    &quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;
    &quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;
    &quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!35F*Y_0D````````````````&quot;
    &quot;````````````````````````````````````````````````````````````````&quot;
    ...
</code></pre>
<p>The header can be large, e.g. a few MBs. </p>
<p>As a result, the raw RGB values will be compiled as an array in our kernel. </p>
<h3 id="adjust-the-linker-script">Adjust the linker script</h3>
<p>Now build the kernel. You may see an error like this:</p>
<pre><code>aarch64-linux-gnu-ld -T build-qemu/linker.ld -o build-qemu/kernel8.elf  build-qemu/mbox_c.o build-qemu/lfb_c.o build-qemu/kernel_c.o build-qemu/irq_c.o build-qemu/mini_uart_c.o build-qemu/printf_c.o build-qemu/timer_c.o build-qemu/timer_s.o build-qemu/utils_s.o build-qemu/irq_s.o build-qemu/entry_s.o build-qemu/mm_s.o build-qemu/boot_s.o
build-qemu/boot_s.o: In function `el1_entry':
/data/teaching/p1-kernel-workspace/p1-kernel/src/exp3-bonus/src/boot.S:44:(.text.boot+0x38): relocation truncated to fit: R_AARCH64_ADR_PREL_LO21 against symbol `bss_begin' defined in .bss section in build-qemu/kernel8.elf
/data/teaching/p1-kernel-workspace/p1-kernel/src/exp3-bonus/src/boot.S:45:(.text.boot+0x3c): relocation truncated to fit: R_AARCH64_ADR_PREL_LO21 against symbol `bss_end' defined in .bss section in build-qemu/kernel8.elf
Makefile:49: recipe for target 'kernel8.img' failed
make: *** [kernel8.img] Error 1
</code></pre>
<p>Understand this is a linker error: because the message shows up when invoking <code>ld</code>. </p>
<p>Per the error message, this error is about <code>el1_entry</code>. </p>
<pre><code>el1_entry:
    adr x0, bss_begin
    adr x1, bss_end
</code></pre>
<p>It refers to two symbols bss_begin and bss_end using instructions ADR ("R_AARCH64_ADR_PREL_LO21"). The instructions encode the addresses of bss_begin/end as relative offsets to PC. The maximum offsets are 21 bits ("LO21"). Now we put lots of extra bytes in .data section, el1_entry is too far away from bss_begin/end. This can be seen from the existing linker script, where .data is sandwiched in between .text.boot and .bss. </p>
<pre><code>SECTIONS
{
    . = START_ADDR;
    .text.boot : { *(.text.boot) }
    .text : { *(.text) }
    .rodata : { *(.rodata) }
    .data : { *(.data) }
    . = ALIGN(0x8);
    bss_begin = .;
    .bss : { *(.bss*) } 
    bss_end = .;        
}
</code></pre>
<p>Solution: move .bss to right after .text and we are good. </p>
<h3 id="updating-the-framebuffer">Updating the framebuffer</h3>
<p><code>lfb_update</code> simply increments virt offsets via mbox to the GPU. </p>
<p>From the timer interrupt, we call <code>lfb_update</code>: </p>
<pre><code>void handle_generic_timer_irq( void ) 
{
    gen_timer_reset(interval);
    lfb_update(); // refresh fb
}
</code></pre>
<h2 id="known-issues">Known issues</h2>
<h2 id="reference">Reference</h2>
<ol>
<li>
<p>https://github.com/bztsrc/raspi3-tutorial/tree/master/09_framebuffer</p>
</li>
<li>
<p>https://github.com/brianwiddas/pi-baremetal</p>
</li>
</ol>
<h2 id="as-tribute-to">As tribute to...</h2>
<p>KONAMI, Fighting Eleven World Soccer 2, Super Famicom, 1995. </p>
<p><img alt="" src="../fighting11.gif" /></p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.b88e97c5.min.js"></script>
      
    
  </body>
</html>